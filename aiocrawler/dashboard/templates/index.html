<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="imgs/favicon.ico" type="image/x-icon" />
    <title>Aiocrawler Dashboard</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
</head>
<body class="sidebar-fixed header-fixed">
<div class="page-wrapper">
   <nav class="navbar page-header">
        <a class="navbar-brand" href="#">
            <img src="imgs/logo.png" width="32" height="32" class="d-inline-block align-top" alt="">
            Aiocrawler Dashboard
        </a>

        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="small ml-1 d-md-down-none">{{username}}</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                    <div class="dropdown-header">Settings</div>

                    <a href="#" class="dropdown-item">
                        <i class="fa fa-cog fa-fw"></i> Settings
                    </a>

                    <a href="#" class="dropdown-item">
                        <i class="fa fa-user"></i> Profile
                    </a>

                    <a href="logout" class="dropdown-item">
                        <i class="fa fa-lock"></i> Logout
                    </a>
                </div>
            </li>
        </ul>
    </nav>

    <div class="main-container">
        <div class="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav">
                    <li class="nav-title">Menu</li>

                    <li class="nav-item">
                        <a href="index.html" class="nav-link active">
                            <i class="icon icon-speedometer"></i> Dashboard
                        </a>
                    </li>

                    <li class="nav-item nav-dropdown">
                        <a href="#" class="nav-link nav-dropdown-toggle">
                            <i class="icon icon-target"></i> Configure <i class="fa fa-caret-left"></i>
                        </a>

                    </li>
                </ul>
            </nav>
        </div>

        <div class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card p-4">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="h4 d-block font-weight-normal mb-2" id="aiocrawler-count"> 0 </span>
                                    <span class="font-weight-light">Running aiocrawlers</span>
                                </div>

                                <div class="h2 text-muted">
                                    <i class="fas fa-chalkboard" style="font-size: 24px;"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card p-4">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="h4 d-block font-weight-normal mb-2" id="item-count"> 0 </span>
                                    <span class="font-weight-light">Total crawled items</span>
                                </div>

                                <div class="h2 text-muted">
                                    <i class="icon icon-wallet"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card p-4">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="h4 d-block font-weight-normal mb-2" id="downloaded-count"> 0 </span>
                                    <span class="font-weight-light">Downloaded requests</span>
                                </div>

                                <div class="h2 text-muted">
                                    <i class="icon icon-cloud-download"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card p-4">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="h4 d-block font-weight-normal mb-2" id="request-count"> 0 </span>
                                    <span class="font-weight-light">Total requests</span>
                                </div>

                                <div class="h2 text-muted">
                                    <i class="icon icon-cloud-download"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row ">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="p-4">
                                    <div id="chart" style="width: 100%; height: 400px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/echarts.js"></script>
<script>
        <!-- Initialize data -->
        let interval = 5000;
        // let num = Math.ceil(2 * 60 * 60 * 1000 / interval);
        // let data = [];
        //
        // let now = +new Date();
        // for (let i = num - 1; i > 0; i--)
        // {
        //     let time = new Date(+now - i * interval);
        //     data.push(generateData(time, 0));
        // }
        //
        // function generateData(now, value){
        //     return {
        //         name: now.toString(),
        //         value: [
        //             now.toLocaleDateString() + ' ' + [now.getHours(), now.getMinutes(), now.getSeconds()].join(':'),
        //             value
        //         ]
        //     }
        // }

        let ctx = document.getElementById("chart");
        let option = {
            title: {
                text: 'Item count'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    animation: false
                }
            },
            xAxis: {
                type: 'time',
                splitLine: {
                    show: false
                },
                name: 'time'
            },
            yAxis: {
                type: 'value',
                boundaryGap: [0, '10%'],
                splitLine: {
                    show: true
                },
                name: 'count'
            },
            // visualMap: {
            //     top: 10,
            //     right: 10,
            //     pieces: [{
            //         gt: 0,
            //         lte: 30,
            //         color: '#096'
            //     }, {
            //         gt: 30,
            //         lte: 50,
            //         color: '#ffde33'
            //     }, {
            //         gt: 50,
            //         lte: 150,
            //         color: '#ff9933'
            //     }, {
            //         gt: 150,
            //         lte: 200,
            //         color: '#cc0033'
            //     }, {
            //         gt: 200,
            //         lte: 300,
            //         color: '#660099'
            //     }, {
            //         gt: 300,
            //         color: '#7e0023'
            //     }],
            //     outOfRange: {
            //         color: '#999'
            //     }
            // },
            series: [{
                name: 'Item count',
                type: 'line',
                showSymbol: false,
                smooth: false,
                itemStyle: {
                    normal: {
                        color: "#FF9933"
                    },
                    lineStyle: "#909878"
                }
            }]
        };

        let chart = echarts.init(ctx);
        chart.setOption(option, true);
        chart.showLoading();

        function changeChart(itemInfo){
            chart.setOption({
                series: [{
                    data: itemInfo
                }]
            })
        }
        function update(data){
            let itemInfo = data["item_info"];
            let itemCount = itemInfo.length > 0 ? itemInfo[itemInfo.length-1]["value"][1] : 0;
            $("#aiocrawler-count").html(data["aiocrawler_count"]);
            $("#item-count").html(itemCount);
            $("#downloaded-count").html(data["download_count"]);
            $("#request-count").html(data["request_count"]);
            changeChart(itemInfo);
        }

        function updateInfo(){
            $.ajax({
                url: 'update',
                method: 'GET',
                async: true,
                dataType: 'jsonp',
                jsonpCallback: 'update'
            });
        }

        $(document).ready(() => {
            updateInfo();
            chart.hideLoading();
            setInterval(updateInfo, interval);
        });
        window.onresize = () =>{
            chart.resize();
        };

</script>

</html>
